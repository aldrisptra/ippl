<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Keamanan Kotak Infaq</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 340px;
        height: 100vh;
      }
      #view {
        position: relative;
        background: #000;
      }
      video,
      canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      aside {
        padding: 16px;
        border-left: 1px solid #ddd;
        overflow: auto;
      }
      button,
      input {
        margin: 6px 0;
        padding: 8px 12px;
      }
      .status {
        font-weight: 700;
      }
      .ok {
        color: #0a0;
      }
      .warn {
        color: #d80;
      }
      .alert {
        color: #c00;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      pre {
        height: 45vh;
        overflow: auto;
        background: #f7f7f7;
        border: 1px solid #ddd;
        padding: 8px;
      }
      .hint {
        font-size: 12px;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div id="view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <aside>
      <h2>Keamanan Kotak Infaq</h2>
      <p>Status: <span id="status" class="status">Inisialisasi…</span></p>

      <div class="row">
        <button
          id="btn-audio"
          title="Wajib diklik agar browser mengizinkan bunyi/TTS"
        >
          Aktifkan Audio
        </button>
        <button
          id="btn-box"
          title="Klik & drag di video untuk menandai area kotak"
        >
          Tandai ROI Kotak
        </button>
        <button
          id="btn-zone"
          title="Klik & drag di video untuk menandai area orang mendekat"
        >
          Tandai Zona Waspada
        </button>
      </div>

      <div class="row">
        <label
          >FPS kirim:
          <input
            id="fps"
            type="number"
            value="6"
            min="1"
            max="15"
            style="width: 64px"
          />
        </label>
        <button id="btn-reset" title="Reset background ROI di server">
          Reset Background ROI
        </button>
      </div>

      <div class="row">
        <button id="btn-demo" title="Set ROI & Zona contoh untuk tes cepat">
          Auto Set ROI & Zona (tes)
        </button>
        <button id="btn-clear" title="Hapus ROI & Zona yang tersimpan">
          Hapus ROI/Zona
        </button>
      </div>

      <p class="hint">
        Tandai ROI tepat di kotak infaq, dan Zona Waspada di area orang bisa
        menjangkau kotak. Atur FPS 5–8 untuk CPU.
      </p>
      <p>Log:</p>
      <pre id="log"></pre>
    </aside>

    <script>
      // ====== Elemen & konteks ======
      const video = document.getElementById("video");
      const canvas = document.getElementById("overlay");
      const ctx = canvas.getContext("2d");
      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");

      // ====== State ======
      let ws,
        streaming = false,
        sendTimer = null;
      let boxROI = null,
        warnZone = null;
      let currentTool = null; // 'box' | 'zone'
      let drawing = null; // {type, x0, y0}
      let audioCtx = null;
      let lastStatus = "INIT"; // untuk debounce TTS

      // ====== Util ======
      function log(s) {
        logEl.textContent += s + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }
      function resizeCanvas() {
        if (!video.videoWidth) return requestAnimationFrame(resizeCanvas);
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
      function canvasToFrameXY(e) {
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width / r.width,
          sy = canvas.height / r.height;
        return { x: (e.clientX - r.left) * sx, y: (e.clientY - r.top) * sy };
      }
      function rectFromPts(x0, y0, x1, y1) {
        const x = Math.min(x0, x1),
          y = Math.min(y0, y1);
        return { x, y, w: Math.abs(x1 - x0), h: Math.abs(y1 - y0) };
      }
      function drawRect(r, color) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.strokeRect(r.x, r.y, r.w, r.h);
      }

      // ====== Audio (WebAudio) ======
      function initAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator(),
            g = audioCtx.createGain();
          o.connect(g);
          g.connect(audioCtx.destination);
          g.gain.value = 0;
          o.start();
          o.stop();
        }
        speak("Audio diaktifkan.");
        log("Audio siap.");
      }
      function beep(freq = 880, dur = 300, type = "sine") {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        o.connect(g);
        g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.02);
        o.start();
        setTimeout(() => {
          g.gain.exponentialRampToValueAtTime(
            0.0001,
            audioCtx.currentTime + 0.02
          );
          o.stop();
        }, dur);
      }
      function play(type) {
        if (type === "WARN") {
          beep(750, 180, "triangle");
          setTimeout(() => beep(750, 180, "triangle"), 220);
        }
        if (type === "ALERT") {
          beep(900, 250, "square");
          setTimeout(() => beep(600, 250, "square"), 280);
          setTimeout(() => beep(900, 250, "square"), 560);
        }
      }

      // ====== TTS ======
      let voices = [];
      function loadVoices() {
        voices = window.speechSynthesis.getVoices();
      }
      window.speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
      function speak(text) {
        if (!text) return;
        try {
          const u = new SpeechSynthesisUtterance(text);
          const idVoice = voices.find((v) => /id-|Indonesia/i.test(v.lang));
          if (idVoice) u.voice = idVoice;
          u.rate = 1.0;
          u.pitch = 1.0;
          u.volume = 1.0;
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch (e) {}
      }

      // ====== Kamera (browser) ======
      async function initCam() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: false,
        });
        video.srcObject = stream;
        await video.play();
        resizeCanvas();
        requestAnimationFrame(drawOverlay);
        log("Kamera aktif.");
      }
      function drawOverlay() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (boxROI) drawRect(boxROI, "#00ff88");
        if (warnZone) drawRect(warnZone, "#ffaa00");
        requestAnimationFrame(drawOverlay);
      }

      // ====== Persist config (localStorage) ======
      function persist() {
        if (boxROI) localStorage.setItem("boxROI", JSON.stringify(boxROI));
        if (warnZone)
          localStorage.setItem("warnZone", JSON.stringify(warnZone));
      }
      try {
        const savedBox = localStorage.getItem("boxROI");
        const savedZone = localStorage.getItem("warnZone");
        if (savedBox) boxROI = JSON.parse(savedBox);
        if (savedZone) warnZone = JSON.parse(savedZone);
        if (boxROI && warnZone) {
          log("Config tersimpan dimuat.");
          setTimeout(() => sendConfig(true), 600);
        }
      } catch (_) {}

      // ====== Tombol ======
      document.getElementById("btn-audio").onclick = () => initAudio();
      document.getElementById("btn-box").onclick = () => {
        currentTool = "box";
        log("Mode: ROI Kotak. Klik & drag di video…");
      };
      document.getElementById("btn-zone").onclick = () => {
        currentTool = "zone";
        log("Mode: Zona Waspada. Klik & drag di video…");
      };
      document.getElementById("btn-reset").onclick = () => {
        if (!boxROI) {
          log("Set ROI Kotak dulu.");
          return;
        }
        sendConfig(true);
        log("Reset background ROI diminta.");
      };
      document.getElementById("btn-clear").onclick = () => {
        boxROI = null;
        warnZone = null;
        localStorage.removeItem("boxROI");
        localStorage.removeItem("warnZone");
        log("ROI & Zona dihapus. Silakan tandai ulang.");
        sendConfig(true);
      };
      document.getElementById("btn-demo").onclick = () => {
        const W = canvas.width,
          H = canvas.height;
        if (!W || !H) {
          log("Video belum siap. Coba lagi sebentar.");
          return;
        }
        boxROI = {
          x: Math.round(W * 0.33),
          y: Math.round(H * 0.25),
          w: Math.round(W * 0.34),
          h: Math.round(H * 0.28),
        };
        warnZone = {
          x: Math.round(W * 0.2),
          y: Math.round(H * 0.6),
          w: Math.round(W * 0.6),
          h: Math.round(H * 0.3),
        };
        log("ROI Kotak diset. (auto)");
        log("Zona Waspada diset. (auto)");
        persist();
        sendConfig(true);
      };

      // ====== Menggambar ROI/Zona ======
      canvas.addEventListener("mousedown", (e) => {
        if (!currentTool) {
          log("Pilih tombol ROI Kotak atau Zona Waspada dulu.");
          return;
        }
        const p = canvasToFrameXY(e);
        drawing = { type: currentTool, x0: p.x, y0: p.y };
      });
      canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const p = canvasToFrameXY(e);
        const r = rectFromPts(drawing.x0, drawing.y0, p.x, p.y);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (boxROI) drawRect(boxROI, "#00ff88");
        if (warnZone) drawRect(warnZone, "#ffaa00");
        drawRect(r, "#33aaff");
      });
      canvas.addEventListener("mouseup", (e) => {
        if (!drawing) return;
        const p = canvasToFrameXY(e);
        const r = rectFromPts(drawing.x0, drawing.y0, p.x, p.y);
        if (r.w > 5 && r.h > 5) {
          if (drawing.type === "box") {
            boxROI = r;
            log("ROI Kotak diset.");
            persist();
          } else if (drawing.type === "zone") {
            warnZone = r;
            log("Zona Waspada diset.");
            persist();
          }
          sendConfig(true);
        } else {
          log("Gambar terlalu kecil, coba ulang.");
        }
        drawing = null;
        currentTool = null;
      });

      // ====== WebSocket ke backend ======
      function connectWS() {
        const url =
          (location.protocol === "https:" ? "wss" : "ws") +
          "://" +
          location.host +
          "/ws";
        ws = new WebSocket(url);
        ws.onopen = () => {
          log("WS connected.");
          streaming = true;
          sendConfig();
          startSending();
        };
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            statusEl.textContent = msg.status;
            statusEl.className =
              "status " +
              (msg.status === "ALERT"
                ? "alert"
                : msg.status === "WARN"
                ? "warn"
                : "ok");
            if (msg.play) play(msg.play);
            if (msg.say && msg.status !== lastStatus) speak(msg.say);
            lastStatus = msg.status;
            if (msg.info) log(msg.info);
          } catch (e) {
            log("WS parse error");
          }
        };
        ws.onclose = () => {
          log("WS closed. Reconnect dalam 1.5s…");
          streaming = false;
          clearInterval(sendTimer);
          setTimeout(connectWS, 1500);
        };
        ws.onerror = () => log("WS error");
      }

      function sendConfig(forceReset = false) {
        if (!ws || ws.readyState !== 1) return;
        const roundRect = (r) =>
          r
            ? {
                x: Math.round(r.x),
                y: Math.round(r.y),
                w: Math.round(r.w),
                h: Math.round(r.h),
              }
            : null;
        ws.send(
          JSON.stringify({
            type: "config",
            boxROI: roundRect(boxROI),
            warnZone: roundRect(warnZone),
            reset: forceReset,
            w: canvas.width,
            h: canvas.height,
          })
        );
      }

      function startSending() {
        const fpsEl = document.getElementById("fps");
        const tick = () => {
          if (!streaming || !ws || ws.readyState !== 1) return;
          const tmp = document.createElement("canvas");
          tmp.width = canvas.width;
          tmp.height = canvas.height;
          const tctx = tmp.getContext("2d");
          tctx.drawImage(video, 0, 0, tmp.width, tmp.height);
          const data = tmp.toDataURL("image/jpeg", 0.6);
          ws.send(JSON.stringify({ type: "frame", data }));
        };
        function resetInterval() {
          if (sendTimer) clearInterval(sendTimer);
          let fps = Number(fpsEl.value) || 6;
          fps = Math.max(1, Math.min(15, fps));
          sendTimer = setInterval(tick, 1000 / fps);
        }
        fpsEl.addEventListener("change", resetInterval);
        resetInterval();
      }

      // ====== Start ======
      initCam().then(connectWS);
      window.addEventListener("resize", resizeCanvas);
    </script>
  </body>
</html>
